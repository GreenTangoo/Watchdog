# WideProtectSIEM

Конфигурационные файлы в SIEM системе представлены JSON файлами.

Аггрегация в разработанной SIEM построена на основе конфигурационных файлов.На вход модуль аггрегации получает текстовые файлы с логами, а на выходе появятся файлы с аггрегированной информацией в том формате, которая указана в конфигурационнном файле аггрегации. Пока что выходных форматов 1 - JSON аггрегация(на выходе будут сформированы файлы в формате JSON).

Описание синтаксиса конфигурации файла аггрегации:

aggregation-configs
	Основной json объект, куда заносятся данные конфигурации.

one-config
	Объект, описывающий одну агрегацию.

info-node
	Объект, содержащий детали одной аггрегации.


aggr-behaviour
	Описывает поведение аггрегации. То есть будут ли аггрегированные данные записываться в JSON формат или какой-либо иной.
	Пока доступен только JSON формат, в дальнейшем будут добавляться иные.

category
	Описывает категорию источника аггрегированных данных. Сейчас доступны: iptables, apache.

source-log
	Имя файла исходных логов.

result-log
	Имя результирующего файла после процесса аггрегации. Предыдущие данные файла будут сохранены и 
	перезаписаны вместе с новым результатом.

id
	Идентификатор, по которому можно ссылаться на объект, описывающий конкретные детали агрегации(info-node). 
	Наиболее частое применение, указание пути в ключевом слове parent-node, в JSON аггрегации.

aggr-type
	Тип аггрегации(поиск - find или подсчет - count). При поиске и подсчете, как ключ, так и значение по ключу могут
	задаваться регулярным выражениями. Отличия в том, что при поиске, если найдено значение по ключу, то поиск прекращается,
	а при подсчете, будет вычислено количество значений, удовлетворяющих условию аггрегации.

key-name
	Описывает имя, которое будет присвоено ключу(может принимать регулярное выражение).

value-name
	Описывает имя, которое будет присвоено значению ключа(может принимать регулярные выражения).

key-group
	Номер группы в регулярном выражении, если оно используется для нахождения имени ключа.

value-group
	Номер группы в регулярном выражении, если оно испильзуется для нахождения имени значения.

node-type
	Тип объекта в представлении JSON. Объект, строка или массив.

parent-node
	Путь до родительского JSON объекта, путь следует задать, как абсолютный.В любом случае, лучше ссылаться через id.
	ПРИМЕР: /root/[1]
	ПРИМЕР: /root/[1]/protocols/[3]
	Здесь в квадратных скобках указаны идентификаторы(id) структур info-node, из которых будут браться ключи.
	В результате будет формироваться иерархия JSON файла.

condition
	Задает условие, при котором будет осуществляться проверка аггрегированного значения. Заданное условие влияет на то,
	будет ли аггрегированное значение добавлено в результирующий файл. Если его не задавать, то аггрегированное значение 
	всегда будет попадать в результирующий файл. Формат записи условия: ЛОГИЧЕСКИЙ_ОПЕРАТОР=[id__num, КЛЮЧ/ЗНАЧЕНИЕ]
	ПРИМЕР: and=[1,key]. В результате применения такого условия будет проведена проверка наличия аггрегированного ключа
	в структуре аггрегированных данных, чей идентификатор равен 1. Если такой ключ существует, то условие выполнится, если
	не существует, то нет. Вместо "and" может передаваться "or", который обозначает, что запись аггрегированного выражения
	будет занесена в структуры аггрегированных данных в любом случае. Вместо "key" можно передать "value", который предопределяет
	сравнение по значение, а не ключу у структуры с id = id_num

Пример работы конфигурационного файла аггрегации:
{
    "aggregation-configs":{
		"one-config":{
            "aggr-behaviour":"json",
			"category":"iptables",
			"source-log":"ssh.log",
            "result-log":"ssh.json",
            "info-node":{
                "id":"1",
                "node-type":"object",
                "aggr-type":"find",
                "key-name":"(\d+\.\d+\.\d+\.\d+)",
                "key-group":"1",
                "parent-node":"root"
            },
            "info-node":{
                "id":"2",
                "node-type":"string",
                "aggr-type":"count",
                "key-name":"amount_failed",
                "key-group":"-1",
                "value-name":"(Failed)",
                "value-group":"1",
                "parent-node":"root/[1]",
                "condition":"and=[1,key]"
            }
        }
	}
}

Пример лог-файла логов ssh:
Jun 28 10:25:54 ekv sshd[2348]: Failed password for dworf from 10.0.2.2 port 50817 ssh2
Jun 28 10:25:58 ekv sshd[2348]: Failed password for dworf from 10.0.2.2 port 50817 ssh2
Jul 29 10:25:46 ekv sshd[2348]: Failed password for frodo from 10.0.2.1 port 50812 ssh2
Jul 29 10:22:51 ekv sshd[2348]: Failed password for frodo from 10.0.2.1 port 50812 ssh2
Jul 29 10:22:56 ekv sshd[2348]: Failed password for frodo from 10.0.2.1 port 50812 ssh2

Ожидаемый результат:
{
	"10.0.2.2":{
		"amount_failed":"2"
	},
	"10.0.2.1":{
		"amount_failed":"3"
	}
}
